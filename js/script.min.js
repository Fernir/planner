function InitContext(){var e=null;$("#menu").mouseleave(function(){$(this).hide()});$(".marker").on("contextmenu",function(t){e=null;t.preventDefault();if(!$(t.target).attr("abbr")||!$(t.target).hasClass("marker")){return}e=t.target;$("#menu").menu();$("#menu").css({top:t.pageY-16,left:t.pageX-16});$("#menu").stop(true,true).fadeIn("fast")});$("#editrecord").on("click",function(t){var t=t;$("#menu").hide(0,function(){if(e){inptr(t,$(e))}})});$("#deleterecord").on("click",function(t){$("#menu").hide(0,function(){if(e){var t=$(e).attr("abbr");var n=gdata.markers[t];n.tend=n.tend||"";$("#prompt_window").html("<p>Вы действительно хотите удалить запись?</p>").dialog({modal:true,title:"Внимание!",resizable:false,width:500,buttons:{Ok:function(){csend({view:"week",storage:1,id:t,tstart:n.tstart,tend:n.tend});$(this).dialog("close");return},Cancel:function(){$(this).dialog("close");return}}})}})})}var inter=null;var editmode=false;var weekdays=["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"];var months=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];var gdata=null;var j$=function(d){return eval("("+d+")")};$.fn.tmpl=function(e,t,n){var r=this;if(!$("#tmpl_"+e).length){$.ajax({url:e+".tmpl",cache:false}).done(function(i){$('<script type="text/x-dot-template" id="tmpl_'+e+'"></script>').html(i).appendTo($("body"));var s=doT.template($("#tmpl_"+e).html());if(!$.isArray(t))t=[t];return r.each(function(){var e="";for(var i=0;i<t.length;i++){e+=s(t[i])}$(r).html(e);if(n)n()})})}else{var i=doT.template($("#tmpl_"+e).html());if(!$.isArray(t))t=[t];return this.each(function(){var e="";for(var r=0;r<t.length;r++){e+=i(t[r])}$(this).html(e);if(n)n()})}};String.prototype.format=function(){var e=this;for(var t in arguments)e=e.replace("{"+t+"}",arguments[t]);return e};var updateColors=function(){$("#customCSS").remove();$("head").append('<style id="customCSS">.marker { background-color:'+gdata.color+"; }</style>")};var dblclick=function(e,t,n){$(e).removeAttr("readonly").focus().change(function(){$(this).attr("readonly","readonly");csend({view:"roomlist",mode:"editroom",roomid:t,roomname:$(this).val()})})};var changerows=function(e){var t=$("#amount_tstart").text();var n=$("#amount_tend").text();if($("#checkmonths").is(":checked")){csend({view:"week",action:"checkfield",id:$("#idvalue").val(),user:$("#uservalue").val(),addmonths:$("#months").val(),tstart:t,tend:n},e)}else{csend({view:"week",action:"checkfield",id:$("#idvalue").val(),user:$("#uservalue").val(),tstart:t,tend:n},e)}};var dodialog=function(e,t,n){n=n|"Внимание!";$("#prompt_window").html(e).dialog({modal:true,title:n,resizable:false,width:500,buttons:{Ok:function(){$(this).dialog("close");(new Function(t))();return},Cancel:function(){$(this).dialog("close");return}}})};var alreadyShown=false;var inptr=function(e,t){if(alreadyShown)return;alreadyShown=true;var n=e.target||e.srcElement;if(!(e.button==1||e.button==0))return;if(n.className.indexOf("resizable-handle")>0)return;var r=gdata.markers?gdata.markers[$(t).attr("abbr")]?gdata.markers[$(t).attr("abbr")]:[]:[];r.tend=r.tend||"";r.tstart=r.tstart||6.5+$(t).parent().index()/2+"";r.user=r.user||gdata.user;r.week=r.week||$(t).index()-1;r.id=r.id||t.attr("abbr");r.ts=r.ts||"";var i=r.tstart.replace(":30",".5").replace(":00","").replace(":0","");var s=r.tend.replace(":30",".5").replace(":00","").replace(":0","");$("#slider-range").slider({range:true,min:7,max:22.5,step:.5,values:[i,s||parseInt(i)+1],slide:function(e,t){var n=t.values[0]%1>0?t.values[0].toString().replace(".5",":30"):t.values[0]+":00";var r=t.values[1]%1>0?t.values[1].toString().replace(".5",":30"):t.values[1]+":00";if(!$("#amount_tstart").length){$(".ui-slider-handle:first").html('<div id="amount_tstart" class="ui-widget tooltip">'+n+"</div>");$(".ui-slider-handle:last").html('<div id="amount_tend" class="ui-widget tooltip">'+r+"</div>")}else{$("#amount_tstart").text(n);$("#amount_tend").text(r)}changerows()}});var o=$("#slider-range").slider("values",0);var u=$("#slider-range").slider("values",1);o=o%1>0?o.toString().replace(".5",":30"):o+":00";u=u%1>0?u.toString().replace(".5",":30"):u+":00";if(!$("#amount_tstart").length){$(".ui-slider-handle:first").html('<div id="amount_tstart" class="ui-widget tooltip">'+o+"</div>").hover(function(){$(this).parent().find(".ui-slider-handle:last").css("z-index","999");$(this).css("z-index","1000")});$(".ui-slider-handle:last").html('<div id="amount_tend" class="ui-widget tooltip">'+u+"</div>").hover(function(){$(this).parent().find(".ui-slider-handle:first").css("z-index","999");$(this).css("z-index","1000")})}$("#checkmonths").attr("checked",false);$("#skull").empty();$("#months").attr("value","1");$("#idvalue").attr("value",r.id);$("#uservalue").attr("value",r.user);$("#msgboxval").attr("value",decodeURIComponent(r.data||r.user));$("#msgboxform").dialog({resizable:false,width:600,title:weekdays[r.week]+", "+r.user+(r.ts?", "+r.ts:""),modal:true,open:function(e,t){},buttons:{"Сохранить":function(){var e=this;changerows(function(){if(gdata.conflict){$("#prompt_window").html("<p>Вы пытаетесь добавить событие, время которого пересекается с другими событиями!</p>").dialog({modal:true,title:"Внимание!",resizable:false,width:500,buttons:{Ok:function(){alreadyShown=false;$(this).dialog("close");return}}})}else{var t=$(e).find("#amount_tstart").text();var n=$(e).find("#amount_tend").text();var i=$(e).find("#checkmonths").is(":checked")?$(e).find("#months").val():0;var s=$(e).find("#msgboxval").val();$(e).dialog("close");csend({view:"week",storage:1,id:r.id,data:s,tstart:t,tend:n,addmonths:i})}})},"Отмена":function(){$(this).dialog("close")}}}).on("dialogclose",function(e){clearInterval(inter);alreadyShown=false})};var csend=function(e,t,n){$.ajax({dataType:"json",type:"post",url:"core.php",data:e,success:function(r){if(n)location.assign("/");gdata=r;if(e.action&&e.action=="checkfield"){$("#skull").tmpl("skull",gdata)}else{$("#container").tmpl("maintemplate",gdata,function(){updateJs();menu(gdata.menu);InitContext()})}if(t&&typeof t=="function"){t()}},error:function(){$("#container, #data").empty()}})};var menu=function(e){obj=$("#selectroom");if(!obj.get(0))return;var t,n,r;t=$("#menuholder").get(0);if(!t){t=$("<div>").css({display:"inline-block",cursor:"pointer"}).appendTo(obj);n=$("<div>").css({cursor:"pointer",position:"absolute","z-index":999}).hide().on("mouseleave",function(){$(this).hide("fast")}).appendTo(t);r=$("<div>").addClass("button_sand").css({cursor:"pointer",display:"block"}).on("click",function(){n.toggle("fast")}).appendTo(t)}for(v in e){$("<div>").addClass("menu button_sand").attr("abbr",e[v].id).css({backgroundColor:e[v].color,borderTop:"none",width:"100%",cursor:"pointer",display:"block"}).html(e[v].text).on("click",function(){csend({room:$(this).attr("abbr")})}).appendTo(n);if(e[v].selected)r.html(e[v].text).css({background:e[v].color,color:"#000"})}n.css({top:t.offset().top+t.height()})};var updateJs=function(){$.datepicker.regional["ru"]={closeText:"Закрыть",prevText:"&laquo;&nbsp;Пред",nextText:"След&nbsp;&raquo;",currentText:"Сегодня",monthNames:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],monthNamesShort:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],dayNames:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],dayNamesShort:["вск","пнд","втр","срд","чтв","птн","сбт"],dayNamesMin:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"],weekHeader:"Не",dateFormat:"yy/mm/dd",firstDay:1,isRTL:false,showMonthAfterYear:false,yearSuffix:""};$.datepicker.setDefaults($.datepicker.regional["ru"]);$("#months").spinner();$("#checkmonths").button();$("#months, #checkmonths").change(function(){$("#months").spinner("disable");$("#slider-range").slider("disable");changerows(function(){$("#months").spinner("enable");$("#slider-range").slider("enable")});$("#months").spinner("option","disabled",$("#checkmonths").button("option","disabled"))});$("#months").spinner("option","disabled",$("#checkmonths").attr("checked")?false:true);for(v in gdata.markers){var e=gdata.markers[v];$("td [abbr="+e.id+"]").empty();$("<div>").addClass("marker").attr({title:decodeURIComponent(e.data)+(e.ts?"\n\n"+e.ts.replace(" ","\n"):""),abbr:e.id}).css({height:e.height}).text(e.user).appendTo($("td [abbr="+e.id+"]"))}$(document).keyup(function(e){if(e.keyCode==27)$("#msgbox, #prompt").hide()});$(".marker, .parent_container td").mouseup(function(e){if(!editmode&&e.button!=2&&!$(this).is("td:first-child")){inptr(e,$(this))}});$(".mmo").on("click",function(){csend({view:"week",date:$(this).attr("abbr")})});$("#menuholder").empty();$("html, document").tooltip({show:100,hide:100,position:{my:"center bottom-10",at:"center top"}});$(".colorpicker").colorPicker(function(e,t){csend({view:"roomlist",mode:"roomcolor",roomid:$(t).attr("id").replace("color",""),roomcolor:e})});updateColors();$("#calen").datepicker({changeMonth:true,changeYear:true,showButtonPanel:true,defaultDate:gdata.year+"/"+sprintf("%.2d",gdata.month)+"/"+sprintf("%.2d",gdata.day),onSelect:function(e){csend({view:"week",date:(new Date(e)).getTime()/1e3})},onChangeMonthYear:function(e,t){csend({view:"week",date:(new Date(e,t-1,(new Date).getDate())).getTime()/1e3})}});$(".ui-datepicker-trigger").addClass("button_sand").removeClass("ui-datepicker-trigger");$(".ui-datepicker").removeClass("ui-widget-content")};var drawWeek=function(e,t,n){if(!e)e=date("j",time());if(!t)t=date("m",time());if(!n)n=date("Y",time());var r=date("N",mktime(0,0,0,t,e,n));var s=$("<div />");var o=$("<table class='border1px parent_container' align='center' />");var u=$("<tr/>");u.appendTo(o);for(j=7;j<=22.5;j+=.5){tm=j-intval(j)!=.5?j+":00":intval(j)+":30";timestamp=j-intval(j)!=.5?j+":00":"";var a=$("<tr>");a.appendTo(o);var f=$("<td class='num_offset"+(j==date("N",time())?" num_offset_today":"")+"'>");f.appendTo(a);if(timestamp){$("<div>"+timestamp+"</div>").appendTo(f)}for(i=1;i<=7;i++){monthnow=intval(date("m",strtotime("- "+(i-r)+" days",strtotime(e+"-"+t+"-"+n+" "+tm))));daynow=intval(date("j",strtotime("- "+(i-r)+" days",strtotime(e+"-"+t+"-"+n+" "+tm))));field_id=strtotime(daynow+"-"+monthnow+"-"+n+" "+tm);tclass=(j==date("H",time())?"green_line":"")+(i==date("N",time())?" back_green":"")+(j%1==0?" du":" dd");var f=$("<td abbr='"+field_id+"'"+(tclass?" class='"+tclass+"'":"")+"></td>");f.appendTo(a)}}u.append('<td class="num_offset">&nbsp;</td>');for(i=1;i<=7;i++){daynow=intval(date("j",strtotime("- "+(i-r)+" days",strtotime(e+"-"+t+"-"+n))));var l=$("<th class='dates' "+(i==date("N",time())?" style='color:#00ab22;'":"")+">"+weekdays[i-1]+" "+daynow+"</th>");u.append(l)}o.appendTo(s);return s.html()};var drawMonth=function(e,t,n){if(!e)e=intval(date("m",time()));if(!t)t=intval(date("Y",time()));days_in_this_month=intval(date("t",mktime(0,0,0,e,1,t)));days_in_prev_month=intval(date("t",mktime(0,0,0,e-1,1,t)));week_day=intval(date("N",mktime(0,0,0,e,1,t)));var r=$("<div />");if(n){$('<p align="center"><b>'+months[e-1]+"</b></p>").appendTo(r)}else{$('<h1 style="padding-left:1em; text-align:left;">'+months[e-1]+", "+t+"</h1>").appendTo(r)}var i=$('<table class="border1px txtcontent'+(n?"":" monthtable")+'" align="center">').appendTo(r);var s=1;var o=week_day;var u=week_day;var a=0;if(!n){if(o>1){start_prev=days_in_prev_month-o+2;var f=$("<tr>").appendTo(i);for(days=1;days<o;days++){ts=strtotime(start_prev+"-"+(e-1)+"-"+t+" 00:00");var l=$('<td width="14%" class="'+(days>5?"back_gray ":"")+'mmo" abbr="'+ts+'">'+weekdays[days-1]+", "+start_prev+"</td>").appendTo(f);start_prev++;a++}}}week=1;for(days=o;days<=days_in_this_month+u-1;days++){ts=strtotime(s+"-"+e+"-"+t+" 00:00");if(week_day==1)var f=$("<tr>").appendTo(i);if(days==o){if(week_day>5){if(week==1&&!n){var l=$('<td class="back_gray mmo" abbr="'+ts+'">'+weekdays[week_day-1]+", "+s+"</td>").appendTo(f)}else{var l=$('<td class="back_gray mmo" abbr="'+ts+'">'+s+"</td>").appendTo(f)}}else if(week==1&&!n){var l=$('<td class="mmo" abbr="'+ts+'">'+weekdays[week_day-1]+", "+s+"</td>").appendTo(f)}else{var l=$('<td class="mmo" abbr="'+ts+'">'+s+"</td>").appendTo(f)}s++;o++}else{$("<td>").appendTo(f)}if(week_day==7){week++}week_day%=7;week_day++}if(week_day<=7&&week_day>1){a=week_day;for(days=1;days<=7-week_day+1;days++){ts=strtotime(days+"-"+(e+1)+"-"+t+" 00:00");if(a>5){var l=$('<td class="mmo back_gray">'+days+"</td>").appendTo(f)}else{var l=$('<td class="mmo">'+days+"</td>").appendTo(f)}a++}}return r.html()};var drawYear=function(e){var t=$("<div />");$('<h1 style="padding-left:1em;">'+e+"</h1>").appendTo(t);var n=$('<table cellpadding="10">').appendTo(t);var r=1;for(i=1;i<=3;i++){var s=$("<tr>").appendTo(n);for(j=1;j<=4;j++){var o=$('<td valign="top">'+drawMonth(r,e,true)+"</td>").appendTo(s);r++}}return t.html()};$(function(){if(!gdata)csend({})})